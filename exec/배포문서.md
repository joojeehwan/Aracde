# ğŸŒë°°í¬ ê°€ì´ë“œ

## ì„œë¹„ìŠ¤ ë²„ì „

- IDE
  - IntelliJ IDEA Ultimate : 2021.3.1
  - VSCode : 1.67.1
- Front-End
  - Node.js : 16.14.0
  - React : 17.0.2
  - sockjs : 1.6.0
  - typescript : 4.6.4
  - zustand : 4.0.0-rc.1
- Back-End
  - Java :  11.0.13
  - Spring boot : 2.6.2
  - Gradle : 7.1
  - Websocket : 2.6.6
  - STOMP : 2.3.3-1
- DB
  - MariaDB : 10.7.3 GA
  - Redis : 3.0.504
- ë°°í¬ ì„œë²„
  - Ubuntu : 20.04 LTS
  - Docker : 20.10.7
  - Jenkins : 2.332.2
  - Nginx : 1.21.4

## ë¹Œë“œì— í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜

### application-aws.properties

- íŒ€ì› ê°œì¸ ê³„ì • ì‚¬ìš©

```properties
cloud.aws.credentials.accessKey=ë°œê¸‰ë°›ì€ ê°’
cloud.aws.credentials.secretKey=ë°œê¸‰ë°›ì€ ê°’
cloud.aws.s3.bucket=ì„œë¹„ìŠ¤ì— ì‚¬ìš©í•  ë²„í‚· ì´ë¦„
cloud.aws.region.static=ap-northeast-2
cloud.aws.stack.auto=false
```



### application-db.properties

```properties
spring.datasource.driver-class-name=org.mariadb.jdbc.Driver
spring.datasource.url=jdbc:mariadb://ì„œë¹„ìŠ¤ì£¼ì†Œ:3307/ìŠ¤í‚¤ë§ˆì´ë¦„?useSSL=false&characterEncoding=UTF-8&serverTimezone=Asia/Seoul
spring.datasource.username=ê³„ì •
spring.datasource.password=ë¹„ë°€ë²ˆí˜¸

# redis config
spring.redis.host=ì„œë¹„ìŠ¤ì£¼ì†Œ
spring.redis.port=ì›í•˜ëŠ”í¬íŠ¸(ë³´í†µ 6379)
spring.redis.password=ë¹„ë°€ë²ˆí˜¸
```



### application-social.properties

```properties
kakao.client_id=ë°œê¸‰ë°›ì€ ê°’
kakao.redirect_uri=http://ì„œë¹„ìŠ¤ì£¼ì†Œ:3000/oauth/callback/kakao
naver.client_id=ë°œê¸‰ë°›ì€ ê°’
naver.client_secret=ë°œê¸‰ë°›ì€ ê°’
naver.redirect_uri=http://ì„œë¹„ìŠ¤ì£¼ì†Œ:3000/oauth/callback/naver
google.client_id=ë°œê¸‰ë°›ì€ ê°’
google.client_secret=ë°œê¸‰ë°›ì€ ê°’
google.redirect_uri=http://ì„œë¹„ìŠ¤ì£¼ì†Œ:3000/oauth/callback/google
```



### .env.production

```
REACT_APP_API_ROOT=https://k6a203.p.ssafy.io/apiv1
REACT_APP_API_ROOT_NOTV1=https://k6a203.p.ssafy.io

REACT_APP_GOOGLE_CLIENT_ID=ë°œê¸‰ë°›ì€ ê°’
REACT_APP_KAKAO_CLIENT_ID=ë°œê¸‰ë°›ì€ ê°’
REACT_APP_NAVER_CLIENT_ID=ë°œê¸‰ë°›ì€ ê°’
```



### .env.local

```
REACT_APP_API_ROOT=https://localhost/apiv1
REACT_APP_API_ROOT_NOTV1=http://localhost:8080
REACT_APP_HOME_URL=http://localhost:3000

REACT_APP_GOOGLE_CLIENT_ID=ë°œê¸‰ë°›ì€ ê°’
REACT_APP_KAKAO_CLIENT_ID=ë°œê¸‰ë°›ì€ ê°’
REACT_APP_NAVER_CLIENT_ID=ë°œê¸‰ë°›ì€ ê°’
```



## Openvidu ì„¤ì •íŒŒì¼

/opt/openvidu ê²½ë¡œì— ì„¤ì¹˜í•œ openviduì˜ ì„¤ì • íŒŒì¼ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.

```
ğŸ“ opt/openvidu
  â”œâ”€â”€ğŸ“ cdr
  â”œâ”€â”€ğŸ“ certificates
  â”œâ”€â”€ğŸ“ custom-layout
  â”œâ”€â”€ğŸ“ custom-nginx-locations
  â”œâ”€â”€ğŸ“ custom-nginx-vhosts
  â”œâ”€â”€ğŸ“ front_build âœ¨
  â”‚  â””â”€â”€ğŸ“ build // í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼ í´ë”
  â”œâ”€â”€ğŸ“ kms-crashes
  â”œâ”€â”€ğŸ“ owncert
  â”œâ”€â”€ğŸ“ recordings
  â”œâ”€â”€ğŸ“ƒ .env
  â”œâ”€â”€ğŸ“ƒ nginx.conf
  â”œâ”€â”€ğŸ“ƒ custom-nginx.conf âœ¨
  â”œâ”€â”€ğŸ³ docker-compose.yml âœ¨
  â””â”€â”€ğŸ“ƒ openvidu
```

ì™œëƒí•˜ë©´ openvidu-severë¥¼ ìˆ˜ì •í•œ íŒŒì¼ë¡œ ì‚¬ìš©í•´ì•¼í•˜ê³ , openviduì—ì„œ ì‚¬ìš©í•˜ëŠ” nginxì™€ ê°™ì´ ì“°ê¸° ìœ„í•´ front-end ë¹Œë“œ ê²°ê³¼ë¥¼ volumeìœ¼ë¡œ ì—°ê²°í•˜ì˜€ìŠµë‹ˆë‹¤.

### docker-compose.yml

```
version: '3.1'

services:

    openvidu-server:
        image: openvidu/openvidu-server:arcade -> ì§ì ‘ ë§Œë“  ë„ì»¤ ì´ë¯¸ì§€ ì´ë¦„ìœ¼ë¡œ ë°”ê¿”ì¤ì‹œë‹¤.
...
"ìƒëµ"
...

    nginx:
        image: openvidu/openvidu-proxy:8.0.0
        restart: always
        network_mode: host
        volumes:
            - ./certificates:/etc/letsencrypt
            - ./owncert:/owncert
            - ./custom-nginx-vhosts:/etc/nginx/vhost.d/
            - ./custom-nginx-locations:/custom-nginx-locations
            - ${OPENVIDU_RECORDING_CUSTOM_LAYOUT}:/opt/openvidu/custom-layout
            - ./custom-nginx.conf:/custom-nginx/custom-nginx.conf
            - ./nginx.conf:/etc/nginx/nginx.conf
            - ./front_build/build:/usr/share/nginx/html <- ì¶”ê°€í•´ì•¼í•©ë‹ˆë‹¤.
...
ìƒëµ
...

```



### custom-nginx.conf

```
upstream openviduserver {
    server localhost:5443;
}

server {
    listen 80;
    listen [::]:80;
    server_name k6a203.p.ssafy.io;
    
    # Redirect to https
    location / {
        rewrite ^(.*) https://k6a203.p.ssafy.io:443$1 permanent;
    }    

    # letsencrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location /nginx_status {
        stub_status;
        allow 127.0.0.1;	#only allow requests from localhost
        deny all;		#deny all other hosts	
    }
}


server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name k6a203.p.ssafy.io;
	
    index index.html;
    # SSL Config
    ssl_certificate         /etc/letsencrypt/live/k6a203.p.ssafy.io/fullchain.pem;
    ssl_certificate_key     /etc/letsencrypt/live/k6a203.p.ssafy.io/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/k6a203.p.ssafy.io/fullchain.pem;

    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 5m;
    ssl_stapling on;
    ssl_stapling_verify on;

    ...
    "ìƒëµ"
    ...

    # Your App
    location / {
    #    proxy_pass http://arcade; # Openvidu call by default
        alias /usr/share/nginx/html/;
	try_files $uri $uri/ /index.html;
    }
    
    # websocket
    location /socket {
	proxy_pass http://k6a203.p.ssafy.io:8080/ws-stomp;
	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection "upgrade";
	proxy_set_header Host $host;
	proxy_set_header Origin "";
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	proxy_set_header X-Real-IP $remote_addr;
    }	
    location /apiv1 {
	proxy_pass http://k6a203.p.ssafy.io:8080/apiv1; # ìì‹ ì˜ springboot appì´ì‚¬ìš©í•˜ëŠ” í¬íŠ¸
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
	...
    "ìƒëµ"
    ...

}

```



## ë°°í¬ì‹œ íŠ¹ì´ì‚¬í•­ - openvidu

- application-aws, social, db.properties & .env.production íŒŒì¼ë“¤ì€ git repositoryì— ì˜¬ë¼ê°€ì§€ ì•Šê¸° ë•Œë¬¸ì— mobaXtermì„ ì‚¬ìš©í•´ home/ubuntu ê²½ë¡œì— íŒŒì¼ì„ ì˜¬ë¦°ë’¤ `/var/lib/jenkins/workspace/arcade` ì—ì„œ ê°ìì˜ ê²½ë¡œì— ë§ê²Œ ë³µì‚¬í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.
  - jenkinsê°€ git labì˜ webhookì— ì˜í•´ workspaceì•ˆì˜ ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ ë˜ì–´ë„ ê¸°ì¡´ì— ë³µì‚¬í•´ë‘” íŒŒì¼ë“¤ì´ ì‚¬ë¼ì§€ì§„ ì•ŠìŠµë‹ˆë‹¤.
- openvidu-serverë¥¼ ë¹Œë“œí•˜ë ¤ë©´ openvidu-client, openvidu-java-client ë“±ì´ í•„ìš”í•©ë‹ˆë‹¤. ë”°ë¼ì„œ `var/lib/jenkins` ê²½ë¡œê¹Œì§€ ì˜¨ ë’¤, openvidu ê¹ƒ í”„ë¡œì íŠ¸ë¥¼ í´ë¡ ë°›ìŠµë‹ˆë‹¤. ì´í›„ openvidu ê²½ë¡œì—ì„œ mvn ë¹Œë“œë¥¼ í•˜ë©´ í•„ìš”í•œ jar íŒŒì¼ë“¤ì´ `var/lib/jenkins/.m2` ê²½ë¡œì— ìƒì„±ì´ ë©ë‹ˆë‹¤.

```
ğŸ“ var/lib/jenkins/.m2/repository/io/openvidu/
  â”œâ”€â”€ğŸ“ openvidu-client -> í•„ìš”í•œê±°
  â”œâ”€â”€ğŸ“ openvidu-java-client -> í•„ìš”í•œê±°
  â”œâ”€â”€ğŸ“ openvidu-parent -> í•„ìš”í•œê±°
  â”œâ”€â”€ğŸ“ openvidu-server # ë¹Œë“œí•œ ê²°ê³¼ë¬¼
  â””â”€â”€ğŸ“ openvidu-test-browsers -> í•„ìš”í•œê±°
```

- ì´ íŒŒì¼ë“¤ì´ ì—†ë‹¤ë©´ openvidu-serverê°€ ì œëŒ€ë¡œ ë¹Œë“œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- jenkinsì—ì„œ ë¹Œë“œí•  ë• ec2ì˜ `ubuntu` ê³„ì •ì´ ì•„ë‹Œ `jenkins` ê³„ì •ì´ê¸° ë•Œë¬¸ì— ë¹„ë¡ ubuntuê³„ì •ì— `.m2` í´ë”ê°€ ìˆê³  ê·¸ ì•ˆì— ìœ„ì˜ jar íŒŒì¼ë“¤ì´ ìˆì–´ë„ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ jenkins ê²½ë¡œ ì•ˆì—ì„œ git clone ë°›ê³  mvn ë¹Œë“œë¥¼ í•´ì£¼ëŠ” ê³¼ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.

- `deploy.sh`ì„ jenkinsì—ì„œ ì‹¤í–‰í•˜ê³  ë‚˜ì„œ `/opt/openvidu` ê²½ë¡œì—ì„œ `./openvidu restart` ë¥¼ ì§ì ‘ í•´ì£¼ì–´ì•¼í•©ë‹ˆë‹¤. jenkinsì—ì„œ í•˜ë©´ ì•ˆë˜ëŠ” ì´ìœ ëŠ” openvidu-serverê°€ ìë™ìœ¼ë¡œ ë¡œê·¸ê°€ ëœ¨ê¸° ë•Œë¬¸ì— íƒˆì¶œí•  ìˆ˜ ì—†ì–´ ë¬´í•œìœ¼ë¡œ ë¹Œë“œì¤‘ì¸ ìƒíƒœê°€ ë©ë‹ˆë‹¤.

### Jenkins ì‹¤í–‰ ëª…ë ¹ì–´

```shell
chmod +x deploy.sh
./deploy.sh
```



## ë°°í¬ ê³¼ì •(deploy.sh)

- Jenkinsfileë¡œ í•˜ì§€ ì•Šì€ ì´ìœ ëŠ” docker-compose.ymlì„ ì‚¬ìš©í•˜ê¸° ìœ„í•¨ì´ì—ˆëŠ”ë° frontendê°€ ë”°ë¡œ docker ì´ë¯¸ì§€ê°€ í•„ìš”í•˜ì§€ ì•Šê³  openvidu-serverëŠ” openvidu ì•ˆì˜ docker-compose.ymlì—ì„œ ì§„í–‰í•˜ê¸° ë•Œë¬¸ì— ì‚¬ì‹¤ìƒ docker-compose.ymlì„ ë”°ë¡œ ë§Œë“¤ ì´ìœ ê°€ ì—†ì—ˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ Jenkinsfileë¡œ í•˜ë©´ ì¢‹ì•˜ì„í…ë° ì´ˆë°˜ì˜ ê³„íš ì‹¤ìˆ˜ë¡œ sh íŒŒì¼ì„ ì‹¤í–‰í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

```sh
# jenkinsì˜ ê¸°ì¡´ ê²½ë¡œëŠ” /var/lib/jenkins/workspace/arcade ì´ë‹¤.

# --- ë°±ì—”ë“œ ----

# ê¸°ì¡´ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ë©ˆì¶”ê³  ì§€ìš°ê¸°
docker stop arcade_backend
docker rm arcade_backend

# ê¸°ì¡´ ë°±ì—”ë“œ ì´ë¯¸ì§€ ì§€ìš°ê¸°
docker rmi arcade_backend

# ìƒˆë¡œìš´ ë°±ì—”ë“œ ì´ë¯¸ì§€ ë§Œë“¤ê¸° 
# (arcad_backendë¼ëŠ” ì´ë¦„ìœ¼ë¡œ backendí´ë” ì•ˆì—ìˆëŠ” dockerfileë¡œ ë¹Œë“œ)
docker build -t arcade_backend backend

# ìƒˆë¡œìš´ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰í•˜ê¸°
docker run -d --name arcade_backend -p 8080:8080 arcade_backend


# ---- í”„ë¡ íŠ¸ì—”ë“œ ----
# 1. frontend í´ë”ë¡œ ì´ë™
cd frontend

# 2. npm install & npm run build
npm i
npm run build

# 3. ê¸°ì¡´ì— ìˆë˜ í´ë”ë¥¼ ì§€ìš´ë‹¤.
sudo rm -rf /opt/openvidu/front_build/build

# 4. ë¹Œë“œí•œ ê²°ê³¼ë¬¼ì„ ë³µì‚¬í•œë‹¤.
sudo cp -r build /opt/openvidu/front_build

# --- openvidu ----
# openvidu ì—ì„œ mvn installì€ ë”± í•œë²ˆë§Œ í•´ì£¼ë©´ ëœë‹¤.
# ì´ë•Œ openvidu-client, java client ë“±ì˜ jarë“¤ì´ ìƒê¸°ê³  ì´ jaríŒŒì¼ë“¤ì€ ê³„ì •/.m2 í´ë”ì— ìƒì„±ëœë‹¤.
# ê·¸ jar íŒŒì¼ë“¤ì„ openvidu-server jarë§Œë“¤ë•Œ ì“´ë‹¤. ê·¸ë˜ì„œ ì´ˆê¸°ì— í•œë²ˆë§Œ í•´ì£¼ë©´ ë§¤ë²ˆ ë°°í¬í•  ë•Œë§ˆë‹¤ í•´ì£¼ì§€ ì•Šì•„ë„ ëœë‹¤.
# ì‹¬ì§€ì–´ git clone ë°›ì€ ê²½ë¡œë¡œ ê°€ì„œ openvidu-server í´ë”ë¥¼ ê°ˆì•„ë¼ìš°ì§€ ì•Šì•„ë„ ëœë‹¤.

# 1. ë©”ì´ë¸ ë¹Œë“œ (frontend í´ë”ì—ì„œ ì´ë™í•©ë‹ˆë‹¤.)
cd ../openvidu-server
sudo mvn install -DskipTests

# 2. ë„ì»¤ê²½ë¡œë¡œ ì´ë™í•˜ê¸°
cd docker/openvidu-server

# 3. openvidu-server ì´ë¯¸ì§€ ë¹Œë“œ
sudo chmod +x create_image.sh
./create_image.sh arcade
docker image prune -f

# --- openvidu restart ì•„ë˜ ë¶€ë¶„ì€ ì‹¤í–‰í•˜ë©´ jenkins ë¹Œë“œê°€ ë©ˆì¶”ì§€ ì•Šì•„ì„œ ìˆ˜ë™ìœ¼ë¡œ í•´ì•¼í•©ë‹ˆë‹¤.
# cd /opt/openvidu
# ./openvidu restart
```

